// Code generated by Speakeasy (https://speakeasy.com). DO NOT EDIT.
// @generated-id: 44ddaa7ef4f7

package provider

import (
	"context"
	"encoding/json"
	"github.com/hashicorp/terraform-plugin-framework-jsontypes/jsontypes"
	"github.com/hashicorp/terraform-plugin-framework/diag"
	"github.com/hashicorp/terraform-plugin-framework/types"
	tfTypes "github.com/teamlumos/terraform-provider-lumos/internal/provider/types"
	"github.com/teamlumos/terraform-provider-lumos/internal/sdk/models/operations"
	"github.com/teamlumos/terraform-provider-lumos/internal/sdk/models/shared"
)

func (r *AccessPolicyResourceModel) RefreshFromSharedAccessPolicyOutput(ctx context.Context, resp *shared.AccessPolicyOutput) diag.Diagnostics {
	var diags diag.Diagnostics

	if resp != nil {
		if resp.AccessCondition != nil {
			r.AccessCondition = &tfTypes.AccessPolicyInputAccessCondition{}
			if resp.AccessCondition.MapOfAny != nil {
				if len(resp.AccessCondition.MapOfAny) > 0 {
					r.AccessCondition.MapOfAny = make(map[string]jsontypes.Normalized, len(resp.AccessCondition.MapOfAny))
					for key, value := range resp.AccessCondition.MapOfAny {
						result, _ := json.Marshal(value)
						r.AccessCondition.MapOfAny[key] = jsontypes.NewNormalizedValue(string(result))
					}
				}
			}
			if resp.AccessCondition.One != nil {
				r.AccessCondition.One = &tfTypes.One{}
			}
		}
		r.Apps = []tfTypes.AccessPolicyAppInput{}

		for _, appsItem := range resp.Apps {
			var apps tfTypes.AccessPolicyAppInput

			apps.ID = types.StringValue(appsItem.ID)
			apps.IsPreapproved = types.BoolValue(appsItem.IsPreapproved)
			if appsItem.Permissions != nil {
				apps.Permissions = []tfTypes.AccessPolicyPermissionInput{}

				for _, permissionsItem := range appsItem.Permissions {
					var permissions tfTypes.AccessPolicyPermissionInput

					permissions.ID = types.StringPointerValue(permissionsItem.ID)

					apps.Permissions = append(apps.Permissions, permissions)
				}
			}

			r.Apps = append(r.Apps, apps)
		}
		r.BusinessJustification = types.StringValue(resp.BusinessJustification)
		r.ID = types.StringValue(resp.ID)
		r.Name = types.StringValue(resp.Name)
	}

	return diags
}

func (r *AccessPolicyResourceModel) ToOperationsDeleteAccessPolicyAccessPoliciesAccessPolicyIDDeleteRequest(ctx context.Context) (*operations.DeleteAccessPolicyAccessPoliciesAccessPolicyIDDeleteRequest, diag.Diagnostics) {
	var diags diag.Diagnostics

	var id string
	id = r.ID.ValueString()

	out := operations.DeleteAccessPolicyAccessPoliciesAccessPolicyIDDeleteRequest{
		ID: id,
	}

	return &out, diags
}

func (r *AccessPolicyResourceModel) ToOperationsGetAccessPolicyAccessPoliciesAccessPolicyIDGetRequest(ctx context.Context) (*operations.GetAccessPolicyAccessPoliciesAccessPolicyIDGetRequest, diag.Diagnostics) {
	var diags diag.Diagnostics

	var id string
	id = r.ID.ValueString()

	out := operations.GetAccessPolicyAccessPoliciesAccessPolicyIDGetRequest{
		ID: id,
	}

	return &out, diags
}

func (r *AccessPolicyResourceModel) ToOperationsUpdateAccessPolicyRequest(ctx context.Context) (*operations.UpdateAccessPolicyRequest, diag.Diagnostics) {
	var diags diag.Diagnostics

	var id string
	id = r.ID.ValueString()

	accessPolicyInput, accessPolicyInputDiags := r.ToSharedAccessPolicyInput(ctx)
	diags.Append(accessPolicyInputDiags...)

	if diags.HasError() {
		return nil, diags
	}

	out := operations.UpdateAccessPolicyRequest{
		ID:                id,
		AccessPolicyInput: *accessPolicyInput,
	}

	return &out, diags
}

func (r *AccessPolicyResourceModel) ToSharedAccessPolicyInput(ctx context.Context) (*shared.AccessPolicyInput, diag.Diagnostics) {
	var diags diag.Diagnostics

	var name string
	name = r.Name.ValueString()

	var businessJustification string
	businessJustification = r.BusinessJustification.ValueString()

	var accessCondition *shared.AccessPolicyInputAccessCondition
	if r.AccessCondition != nil {
		var accessCondition1 *shared.AccessCondition1
		if r.AccessCondition.One != nil {
			accessCondition1 = &shared.AccessCondition1{}
		}
		if accessCondition1 != nil {
			accessCondition = &shared.AccessPolicyInputAccessCondition{
				AccessCondition1: accessCondition1,
			}
		}
		var mapOfAny map[string]interface{}
		if r.AccessCondition.MapOfAny != nil {
			mapOfAny = make(map[string]interface{})
			for mapOfAnyKey := range r.AccessCondition.MapOfAny {
				var mapOfAnyInst interface{}
				_ = json.Unmarshal([]byte(r.AccessCondition.MapOfAny[mapOfAnyKey].ValueString()), &mapOfAnyInst)
				mapOfAny[mapOfAnyKey] = mapOfAnyInst
			}
		}
		if mapOfAny != nil {
			accessCondition = &shared.AccessPolicyInputAccessCondition{
				MapOfAny: mapOfAny,
			}
		}
	}
	apps := make([]shared.AccessPolicyAppInput, 0, len(r.Apps))
	for appsIndex := range r.Apps {
		var id string
		id = r.Apps[appsIndex].ID.ValueString()

		isPreapproved := new(bool)
		if !r.Apps[appsIndex].IsPreapproved.IsUnknown() && !r.Apps[appsIndex].IsPreapproved.IsNull() {
			*isPreapproved = r.Apps[appsIndex].IsPreapproved.ValueBool()
		} else {
			isPreapproved = nil
		}
		var permissions []shared.AccessPolicyPermissionInput
		if r.Apps[appsIndex].Permissions != nil {
			permissions = make([]shared.AccessPolicyPermissionInput, 0, len(r.Apps[appsIndex].Permissions))
			for permissionsIndex := range r.Apps[appsIndex].Permissions {
				id1 := new(string)
				if !r.Apps[appsIndex].Permissions[permissionsIndex].ID.IsUnknown() && !r.Apps[appsIndex].Permissions[permissionsIndex].ID.IsNull() {
					*id1 = r.Apps[appsIndex].Permissions[permissionsIndex].ID.ValueString()
				} else {
					id1 = nil
				}
				permissions = append(permissions, shared.AccessPolicyPermissionInput{
					ID: id1,
				})
			}
		}
		apps = append(apps, shared.AccessPolicyAppInput{
			ID:            id,
			IsPreapproved: isPreapproved,
			Permissions:   permissions,
		})
	}
	out := shared.AccessPolicyInput{
		Name:                  name,
		BusinessJustification: businessJustification,
		AccessCondition:       accessCondition,
		Apps:                  apps,
	}

	return &out, diags
}
